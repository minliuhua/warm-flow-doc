# warm-flow 1.2.8ç‰ˆæœ¬æ›´æ–°,æ–°å¢åŠç†äººè¡¨è¾¾å¼å’Œæ¡ä»¶è¡¨è¾¾å¼æ”¯æŒspel

- ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
  - æœ¬æ¬¡å‡çº§ï¼Œå†…ç½®jsonåº“snack3æ–¹å¼ï¼Œæ”¹ä¸ºspiæ–¹å¼åŠ è½½ï¼Œä¸šåŠ¡é¡¹ç›®ä¸­å­˜åœ¨å“ªç§jsonå°±ä¼šä½¿ç”¨å“ªç§çš„å®ç°ï¼Œ
    æ”¯æŒé¡ºåºæŒ‰é¡ºåºåŠ è½½ä¸€ç§ï¼šsnack3ã€jacksonã€fastjsonã€gsonï¼Œå¹¶ä¸”ç›®å‰åªå®ç°äº†è¿™å››ç§ï¼Œå¯æ‰©å±•
  - å¦‚åœ¨æœªé›†æˆsnack3åº“çš„ç¯å¢ƒä¸‹ï¼Œè¿˜éœ€è¦ä½¿ç”¨snack3åº“ï¼Œéœ€è¦å•ç‹¬ä½¿ç”¨ï¼ˆåŸç»„ä»¶ä½¿ç”¨snack3åº“ï¼‰
    ```pom.xml
          <dependency>
              <groupId>org.noear</groupId>
              <artifactId>snack3</artifactId>
              <version>3.2.88</version>
          </dependency>
    ```

- æ›´æ–°æ—¥å¿—
  - [feat] jsonåº“æ”¯æŒsnack3ã€jacksonã€fastjsonå’Œgsonï¼Œå¹¶ä¸”æ”¯æŒæ‰©å±•
  - [feat] å¢åŠ åŠç†äººè¡¨è¾¾å¼ï¼Œæ”¯æŒ${xxx}æ›¿æ¢å’Œspelï¼Œå¹¶æ”¯æŒæ‰©å±•
  - [feat] ListenerVariableç›‘å¬å™¨å˜é‡æ–°å¢FlowParamså­—æ®µï¼Œæ–¹ä¾¿å¼€å§‹ç›‘å¬å™¨å…¨å±€ä¼ é€’å‚æ•°
  - [feat] ç»ˆæ­¢æ–°å¢å¯¹å¼€å§‹å’Œå®Œæˆç›‘å¬å™¨çš„æ”¯æŒ
  - [update] springbooté¡¹ç›®çš„æ¡ä»¶è¡¨è¾¾å¼é»˜è®¤æ”¯æŒspel
  - [update] å†å²è®°å½•æ”¹ä¸ºå•æ¡ä¿å­˜ï¼Œåˆ é™¤é‡å¤ä»£ç 
  - [update] ä¿®æ”¹FlowUserDaoçš„beanåç§°
  - [update] ä¸­é—´èŠ‚ç‚¹æ‹†åˆ†ä¸ºæˆ–ç­¾ï¼Œä¼šç­¾ï¼Œç¥¨ç­¾
  - [fix] ä¿®å¤å†å²è®°å½•åˆ›å»ºæ—¶é—´ç›¸ç­‰ï¼Œå¯¼è‡´æµç¨‹å›¾æ¸²æŸ“å¼‚å¸¸
  - [fix]ä¿®å¤Mybatisé€»è¾‘åˆ é™¤å˜æˆçœŸå®åˆ é™¤çš„ç¼ºé™·                               @xiarigang
  - [refactor] é‡æ„idç”Ÿæˆå™¨ï¼Œæ”¯æŒormé»˜è®¤ç­–ç•¥ï¼Œåˆ é™¤æ•°æ®å¡«å……é»˜è®¤å®ç°ç±»ï¼Œæ”¹ä¸ºåŒ¿åç±»

# éƒ¨åˆ†æ›´æ–°å†…å®¹ä»‹ç»
## 1ã€å¢åŠ åŠç†äººè¡¨è¾¾å¼
### 1.1ã€é»˜è®¤åŠç†äººå˜é‡ç­–ç•¥

#### å‰ç«¯é¡µé¢è®¾ç½®å˜é‡
- æ¯”å¦‚ï¼š`@@default@@|${handler1},role:1,1`
- `@@default@@|${handler1}`ä¸­@@default@@è¡¨ç¤ºé»˜è®¤åŠç†äººå˜é‡ç­–ç•¥ï¼Œhandler1æ˜¯éœ€è¦è¢«æµç¨‹å˜é‡ä¸­æ›¿æ¢çš„æ ‡è¯†
- `role:1,1`è¡¨ç¤ºåŠç†äººè§’è‰²å’Œå…·ä½“åŠç†äºº


<img src="https://foruda.gitee.com/images/1727164067302855332/04f4b2ca_2218307.png"  width="700">



#### åç«¯ä»£ç è®¾ç½®å˜é‡
```java

// æµç¨‹å˜é‡
Map<String, Object> variable = new HashMap<>();
variable.put("handler1", "100");
flowParams.variable(variable);

Instance instance = insService.skipByInsId(testLeave.getInstanceId(), flowParams);
```

### 1.2ã€spelåŠç†äººå˜é‡ç­–ç•¥

#### å‰ç«¯é¡µé¢è®¾ç½®å˜é‡
- æ¯”å¦‚ï¼š`@@spel@@|#{@user.evalVar(#handler2)}`
- `#{@user.evalVar(#handler2)}`æ˜¯spelè¡¨è¾¾å¼ï¼Œ`#handler2`æ˜¯æ–¹æ³•å…¥å‚å˜é‡ï¼Œå¯ä»¥ä¸è®¾ç½®



<img src="https://foruda.gitee.com/images/1727164084637385718/6b68c042_2218307.png"  width="700">



#### åç«¯ä»£ç è®¾ç½®å˜é‡
```java
/**
 * ç”¨æˆ·ç±»
 */
@Component("user")
public class User {

    /**
     * spelåŠç†äººè¡¨è¾¾å¼
     * @param handler2 åŠç†äºº
     * @return String
     */
    public String evalVar(String handler2) {
        return handler2;
    }
}

// æµç¨‹å˜é‡
Map<String, Object> variable = new HashMap<>();
variable.put("handler2", "101");
flowParams.variable(variable);

Instance instance = insService.skipByInsId(testLeave.getInstanceId(), flowParams);
```


## 2ã€ç›‘å¬å™¨å˜é‡æ–°å¢FlowParamså­—æ®µ

>  ListenerVariableç›‘å¬å™¨å˜é‡æ–°å¢FlowParamså­—æ®µï¼Œæ–¹ä¾¿å¼€å§‹ç›‘å¬å™¨å…¨å±€ä¼ é€’å‚æ•°



```java
@Component
public class DefStartListener implements Listener {


  private static final Logger log = LoggerFactory.getLogger(DefStartListener.class);

  /**
   * è®¾ç½®åŠç†äººidã€æ‰€æ‹¥æœ‰çš„æƒé™ç­‰æ“ä½œï¼Œä¹Ÿå¯ä»¥æ”¾åˆ°ä¸šåŠ¡ä»£ç ä¸­åŠç†å‰è®¾ç½®ï¼Œæˆ–è€…èŠ‚ç‚¹ç›‘å¬å™¨
   * @param listenerVariable ç›‘å¬å™¨å˜é‡
   */
  @Override
  public void notify(ListenerVariable listenerVariable) {
    log.info("æµç¨‹å¼€å§‹ç›‘å¬å™¨");

    FlowParams flowParams = listenerVariable.getFlowParams();
    LoginUser user = SecurityUtils.getLoginUser();
    // è®¾ç½®å½“å‰åŠç†äººid
    flowParams.setHandler(user.getUser().getUserId().toString());

    // è®¾ç½®åŠç†äººæ‰€æ‹¥æœ‰çš„æƒé™ï¼Œæ¯”å¦‚è§’è‰²ã€éƒ¨é—¨ã€ç”¨æˆ·ç­‰
    List<String> permissionList = flowParams.getPermissionFlag();
    if (StringUtils.isEmpty(permissionList)) {
      permissionList = new ArrayList<>();
    }

    List<SysRole> roles = user.getUser().getRoles();
    if (Objects.nonNull(roles)) {
      permissionList.addAll(roles.stream().map(role -> "role:" + role.getRoleId()).collect(Collectors.toList()));
    }
    permissionList.add("dept:" + SecurityUtils.getLoginUser().getUser().getDeptId());
    permissionList.add(user.getUser().getUserId().toString());
    flowParams.setPermissionFlag(permissionList);

    log.info("æµç¨‹å¼€å§‹ç›‘å¬å™¨ç»“æŸ......");
  }
}
```

## 3ã€æ¡ä»¶è¡¨è¾¾å¼é»˜è®¤æ”¯æŒspel

> springbooté¡¹ç›®çš„æ¡ä»¶è¡¨è¾¾å¼é»˜è®¤æ”¯æŒspel

- å‰ç«¯é…ç½®å¦‚`#{@user.eval(#flag)}`è¡¨è¾¾å¼ï¼Œå…¥åº“å‰è¦æ‹¼æ¥å‰ç¼€ï¼Œæ–¹ä¾¿åŒºåˆ†è¡¨è¾¾å¼ç±»å‹ï¼Œæœ€ç»ˆä¸º`@@spel@@|#{@user.eval(#flag)}`
- `#flag`ä¸ºå˜é‡å’Œä»¥ä¸‹æ–¹æ³•å…¥å‚å‘½åä¸€è‡´ï¼Œå¯ä¸è®¾ç½®å…¥å‚

<img src="https://foruda.gitee.com/images/1727163098727096928/c29d9af5_2218307.png" width="700">

```java
@Component("user")
public class User {

  /**
   * spelæ¡ä»¶è¡¨è¾¾ï¼šåˆ¤æ–­å¤§äºç­‰4
   * @param flag å¾…åˆ¤æ–­çš„å­—ç¬¦ä¸²
   * @return boolean
   */
  public boolean eval(String flag) {
    BigDecimal a = new BigDecimal(flag);
    BigDecimal b = new BigDecimal("4");
    return a.compareTo(b) > 0;
  }
}

/**
 * æ–°å¢OA è¯·å‡ç”³è¯·
 *
 * @param testLeave OA è¯·å‡ç”³è¯·
 * @return ç»“æœ
 */
@Override
public int insertTestLeave(TestLeave testLeave, String flowStatus)
{
  FlowParams flowParams = FlowParams.build().flowCode(getFlowType(testLeave));
  // æµç¨‹å˜é‡
  Map<String, Object> variable = new HashMap<>();
  variable.put("flag", String.valueOf(testLeave.getDay()));
  flowParams.variable(variable);

  Instance instance = insService.start(id, flowParams);
  return instance != null? 1 : 0;
}
```

# warm-flowä»‹ç»

> [!IMPORTANT]
> Warm-Flowå›½äº§å·¥ä½œæµå¼•æ“ğŸ‰ï¼Œå…¶ç‰¹ç‚¹ç®€æ´è½»é‡ä½†åˆä¸ç®€å•ï¼Œäº”è„ä¿±å…¨ï¼Œç»„ä»¶ç‹¬ç«‹ï¼Œå¯æ‰©å±•ï¼Œå¯æ»¡è¶³ä¸­å°é¡¹ç›®çš„ç»„ä»¶ã€‚

1. ç®€æ´æ˜“ç”¨ï¼šåªæœ‰7å¼ è¡¨ï¼Œä»£ç é‡å°‘ï¼Œå¯å¿«é€Ÿä¸Šæ‰‹å’Œé›†æˆ
2. å®¡æ‰¹åŠŸèƒ½ï¼šæ”¯æŒé€šè¿‡ã€é€€å›ã€ä»»æ„è·³è½¬ã€è½¬åŠã€ç»ˆæ­¢ã€ä¼šç­¾ã€ç¥¨ç­¾ã€å§”æ´¾å’ŒåŠ å‡ç­¾ã€äº’æ–¥å’Œå¹¶è¡Œç½‘å…³
3. ç›‘å¬å™¨ä¸æµç¨‹å˜é‡ï¼šæ”¯æŒäº”ç§ç›‘å¬å™¨ï¼Œå¯åº”å¯¹ä¸åŒåœºæ™¯ï¼Œçµæ´»å¯æ‰©å±•ï¼Œå‚æ•°ä¼ é€’ï¼ŒåŠ¨æ€æƒé™
4. æµç¨‹å›¾ï¼šæµç¨‹å¼•æ“è‡ªå¸¦æµç¨‹å›¾ï¼Œå¯åœ¨ä¸é›†æˆæµç¨‹è®¾è®¡å™¨æƒ…å†µä¸‹ä½¿ç”¨
5. æ¡ä»¶è¡¨è¾¾å¼ï¼šå†…ç½®å¸¸è§çš„å’Œspelæ¡ä»¶è¡¨è¾¾å¼ï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰æ‰©å±•
6. åŠç†äººè¡¨è¾¾å¼ï¼šå†…ç½®${handler}å’Œspelæ ¼å¼çš„è¡¨è¾¾å¼ï¼Œå¯æ»¡è¶³ä¸åŒåœºæ™¯ï¼Œçµæ´»å¯æ‰©å±•
7. ormæ¡†æ¶æ‰©å±•ï¼šç›®å‰æ”¯æŒMyBatisã€Mybatis-Plusã€Mybatis-Flexå’ŒJpaï¼Œåç»­ä¼šç”±ç¤¾åŒºæä¾›å…¶ä»–æ”¯æŒï¼Œæ‰©å±•æ–¹ä¾¿
8. æ•°æ®åº“æ”¯æŒï¼šç›®å‰æ”¯æŒMySQL ã€Oracle å’ŒPostgreSQLï¼Œåç»­ä¼šç»§ç»­æ”¯æŒå…¶ä»–æ•°æ®åº“æˆ–è€…å›½äº§æ•°æ®åº“
9. å¤šç§Ÿæˆ·ä¸è½¯åˆ é™¤ï¼šæµç¨‹å¼•æ“è‡ªèº«ç»´æŠ¤å¤šç§Ÿæˆ·å’Œè½¯åˆ é™¤å®ç°ï¼Œä¹Ÿå¯ä½¿ç”¨å¯¹åº”ormæ¡†æ¶çš„å®ç°æ–¹å¼
10. æ”¯æŒè§’è‰²ã€éƒ¨é—¨å’Œç”¨æˆ·ç­‰æƒé™é…ç½®
11. åŒæ—¶æ”¯æŒspringå’Œsolon
12. å…¼å®¹java8å’Œjava17,ç†è®º11ä¹Ÿå¯ä»¥
13. å®˜æ–¹æä¾›åŸºäºruoyi-vueå°è£…å®æˆ˜é¡¹ç›®ï¼Œå¾ˆå®ç”¨



## æ¼”ç¤ºåœ°å€

- admin/admin123

æ¼”ç¤ºåœ°å€ï¼šhttp://www.hhzai.top



## å®˜ç½‘

[http://warm-flow.cn](https://warm-flow.dromara.org/)
